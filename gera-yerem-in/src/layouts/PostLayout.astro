---
import BaseLayout from './BaseLayout.astro';
import TOC from '../components/TOC.astro';
import type { CollectionEntry } from 'astro:content';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  post: CollectionEntry<'posts'>;
  headings?: Heading[];
}

const { post, headings = [] } = Astro.props;
const { title, description, publishDate, updatedDate, topic, tags, author } = post.data;

// Format dates
const formatDate = (date: Date) => {
  return new Intl.DateTimeFormat('en-US', { 
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  }).format(date);
};

// Calculate reading time (rough estimate)
const readingTime = Math.ceil(post.body.split(/\s+/).length / 200);

// Topic display names
const topicNames: Record<string, string> = {
  'software-development': 'Software Development',
  'digital-marketing': 'Digital Marketing',
  'business-automation': 'Business Automation'
};

// Article schema for structured data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "author": {
    "@type": "Person",
    "name": author,
    "url": "https://gera.yere.in"
  },
  "publisher": {
    "@type": "Person",
    "name": "Gera Yeremin",
    "url": "https://gera.yere.in"
  },
  "datePublished": publishDate.toISOString(),
  "dateModified": (updatedDate || publishDate).toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://gera.yere.in/${post.slug}`
  }
};

// Show TOC for longer posts with headings
const showToc = headings.length > 2;
---

<BaseLayout 
  title={title}
  description={description}
  type="article"
  publishedTime={publishDate.toISOString()}
  modifiedTime={(updatedDate || publishDate).toISOString()}
  author={author}
  showHeader={false}
  theme="light"
>
  <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} slot="head" />
  
  <article class="post">
    <div class="container">
      <div class:list={["post__layout", { "post__layout--with-toc": showToc }]}>
        {showToc && (
          <aside class="post__sidebar">
            <TOC headings={headings} />
          </aside>
        )}
        
        <div class="post__content">
          <header class="post__header post__header--inline">
            <a href={`/topic/${topic}`} class="post__topic">{topicNames[topic]}</a>
            <h1 class="post__title">{title}</h1>
            <div class="post__meta">
              <span>{formatDate(publishDate)}</span>
              <span>Â·</span>
              <span>{readingTime} min read</span>
            </div>
          </header>
          <slot />
        </div>
      </div>
      
      {tags.length > 0 && (
        <footer style="margin-top: var(--space-12); padding-top: var(--space-8); border-top: 1px solid var(--color-border);">
          <div style="display: flex; gap: var(--space-2); flex-wrap: wrap;">
            {tags.map(tag => (
              <span style="padding: var(--space-1) var(--space-3); background: var(--color-background-alt); border-radius: 4px; font-size: var(--font-size-sm); color: var(--color-text-muted);">
                #{tag}
              </span>
            ))}
          </div>
        </footer>
      )}
    </div>
  </article>

  <style>
    /* Two-column layout with TOC sidebar */
    .post__layout {
      display: block;
    }

    .post__layout--with-toc {
      display: block;
    }

    .post__sidebar {
      display: none;
    }

    /* Desktop: show sidebar */
    @media (min-width: 1024px) {
      .post__layout--with-toc {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 5rem;
        align-items: start;
      }

      .post__sidebar {
        display: block;
        position: sticky;
        top: 2rem;
        height: fit-content;
        max-height: calc(100vh - 4rem);
        overflow-y: auto;
      }

      .post__layout--with-toc .post__content {
        min-width: 0;
      }
    }
  </style>
</BaseLayout>

